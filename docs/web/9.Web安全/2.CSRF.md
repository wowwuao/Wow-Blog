---
title: 2.CSRF 攻击

group:
  path: /web-security
  title: Web安全
  order: 9
---

## CSRF攻击

跨站伪造请求，攻击者诱导用户进入一个第三方网站，然后该网站向被攻击网站发送跨站请求。

如果用户在被攻击网站中保存了登录状态，那么攻击者就可以利用这个登录状态，绕过后台的用户验证，冒充用户对服务器执行一些操作。

CSRF攻击的本质：

利用`cookie会在同源请求中携带发送给服务器`的特点，依次来实现用户的冒充。

## 类型
### GET类型
比如在网站中的 img 标签里构建一个请求，当用户打开这个网站就会自动发起提交。

### POST类型
构建一个表单，然后隐藏它，当用户进入这个页面时，自动提交这个表单。

### 链接类型
比如在a标签的href属性里构建一个请求，然后诱导用户去点击。

## 防御

### 1.同源检测
服务器根据请求头中的 origin 或者 referer信息来判断请求是否为允许访问的站点，从而对请求进行过滤。

### 2.Token
服务器向用户返回一个随机数Token，当再次发起请求时，在请求参数中加入服务端返回的 Token，然后服务器对这个Token进行验证。

优点：
解决了cookie单一验证方式，可能会被冒用的问题。

缺点：每次请求都要添加上Token，比较繁琐。如果后端负载均衡的话，要求别的服务器的session也要保留这个token

### 3.双重Cookie
服务器在用户访问页面时，向请求域名注入一个Cookie，内容为随机字符串。当用户再次向服务器发送请求时，从cookie中取出这个字符串，添加到URL中，然后服务器通过对cookie中的数据和参数中的数据进行比较，来进行验证。

这种方式利用了攻击者只能利用 cookie，但是不能获取cookie的特点。这种方法比CSRF Token的方法更加方便，并且不涉及到分布式访问的问题。

缺点：

1. 如果网站存在XSS漏洞，这种方式失效。
2. 这种方式不能做到子域名的隔离。

### 4.Samesite

设置cookie时，设置Samesite，限制cookie不能被第三方使用，从而可以避免。

Samesite一共有两种方式：
1. 严格模式：cookie在任何情况下都不可能作为第三方cookie使用。
2. 宽松模式：cookie可以被请求是GET，并且在发生页面跳转的请求所使用。

#### 什么是Samesite Cookie 属性
表示同站的Cookie，避免Cookie被第三方所使用。

当值为 strict 时，这种模式称为 严格模式，表示这个cookie在任何情况下都不可能作为第三方 cookie

当值为 Lax 时，这种模式称为 宽松模式，如果这个请求是个 GET 请求，并且这个请求改变了当前页面或者打开了新的页面，那么这个页面可以作为第三方 cookie，其余情况都不能作为第三方cookie

缺点：

不支持子域，子域没办法分享主域共享登录信息，每次转入子域的网站，都要重新登录。还有一个问题是兼容性不太好。

